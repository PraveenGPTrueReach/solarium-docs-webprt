<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>QUOTATION_API.md</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji"; margin: 2rem; line-height: 1.6; }
  pre { background:#f6f8fa; padding:1rem; overflow:auto; }
  code { background:#f6f8fa; padding:0.1rem 0.3rem; }
  a { color:#0b5fff; text-decoration:none; }
  a:hover { text-decoration:underline; }
  .container { max-width: 1100px; margin: auto; }
  hr { margin: 2rem 0; }
</style>
</head>
<body>
<div class="container">
<h1>Quotation API Endpoints</h1>
<h2>Overview</h2>
<p>This document details the API endpoints for quotation PDF generation, sharing, and management functionality.</p>
<h2>Authentication</h2>
<p>All endpoints require valid JWT token in Authorization header:</p>
<p>Authorization: Bearer <jwt_token></p>
<h2>Endpoints</h2>
<h3>GET /api/v1/quotations/{id}/pdf</h3>
<p>Retrieves secure PDF download URL for a quotation.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>id</code> (path): Quotation ID (e.g., &quot;QUOTE-001&quot;)</li>
</ul>
<p><strong>Response:</strong></p>
<pre><code class="language-json">{
  &quot;success&quot;: true,
  &quot;data&quot;: {
    &quot;pdfUrl&quot;: &quot;https://blob.storage.azure.com/pdfs/quotations/2024/01/QUOTE-001.pdf?sv=2023-01-03&amp;se=2024-01-15T16%3A00%3A00Z&amp;sr=b&amp;sp=r&amp;sig=mockSignature&quot;,
    &quot;expiresAt&quot;: &quot;2024-01-15T16:00:00Z&quot;
  }
}
Error Responses:

404 Not Found: Quotation or PDF not found
409 Conflict: Cannot generate PDF for draft quotations
403 Forbidden: Insufficient permissions
Role Access: Admin, KAM, CP (with territory restrictions)

PATCH /api/v1/quotations/{id}/share
Shares quotation with customer and marks as immutable.

Parameters:

id (path): Quotation ID
Request Body: {} (empty)

Response:
{
  &quot;success&quot;: true,
  &quot;data&quot;: {
    &quot;id&quot;: &quot;QUOTE-001&quot;,
    &quot;quotationId&quot;: &quot;QUOTE-001&quot;,
    &quot;leadId&quot;: &quot;LEAD-001&quot;, 
    &quot;status&quot;: &quot;Shared&quot;,
    &quot;sharedWithCustomer&quot;: true,
    &quot;sharedAt&quot;: &quot;2024-01-15T15:30:00Z&quot;,
    &quot;customerName&quot;: &quot;John Doe&quot;,
    &quot;systemKW&quot;: 5.0,
    &quot;pricing&quot;: {
      &quot;finalPrice&quot;: 285000,
      &quot;subsidyDetails&quot;: {
        &quot;totalSubsidy&quot;: 78000
      }
    },
    &quot;createdAt&quot;: &quot;2024-01-15T10:00:00Z&quot;,
    &quot;updatedAt&quot;: &quot;2024-01-15T15:30:00Z&quot;
  }
}

Business Rules:

Only quotations with status &quot;Created&quot; can be shared
Lead cannot have multiple final quotations (Shared/Accepted)
Action creates audit log entry &quot;QUOTE SHARED&quot;
Error Responses:

409 Conflict: Lead already has final quotation
400 Bad Request: Invalid quotation status
403 Forbidden: Insufficient permissions
Role Access: Admin, KAM (with territory restrictions)

Integration Examples
Frontend Integration

import { useGetQuotationPdfQuery, useShareQuotationMutation } from &#39;../api/endpoints/quotationEndpoints&#39;;

const QuotationActions = ({ quotation }) =&gt; {
  const { data: pdfData } = useGetQuotationPdfQuery(quotation.id, {
    skip: quotation.status === &#39;Draft&#39;
  });
  
  const [shareQuotation, { isLoading: isSharing }] = useShareQuotationMutation();
  
  const handleShare = async () =&gt; {
    try {
      await shareQuotation({
        id: quotation.id,
        leadId: quotation.leadId
      }).unwrap();
      
      toast.success(&#39;Quotation shared successfully&#39;);
    } catch (error) {
      toast.error(error.data?.message || &#39;Failed to share quotation&#39;);
    }
  };
  
  return (
    &lt;Box&gt;
      {pdfData &amp;&amp; (
        &lt;Button onClick={() =&gt; window.open(pdfData.data.pdfUrl, &#39;_blank&#39;)}&gt;
          View PDF
        &lt;/Button&gt;
      )}
      
      {quotation.status === &#39;Created&#39; &amp;&amp; !quotation.sharedWithCustomer &amp;&amp; (
        &lt;Button onClick={handleShare} disabled={isSharing}&gt;
          Share with Customer
        &lt;/Button&gt;
      )}
    &lt;/Box&gt;
  );
};

Error Handling

const handlePdfError = (error) =&gt; {
  switch (error.status) {
    case 404:
      toast.error(&#39;PDF not available for this quotation&#39;);
      break;
    case 409:
      toast.error(&#39;Cannot generate PDF for draft quotations&#39;);
      break;
    case 403:
      toast.error(&#39;You do not have permission to view this PDF&#39;);
      break;
    default:
      toast.error(&#39;Failed to load PDF. Please try again.&#39;);
  }
};

Security Considerations
SAS Token Security
    PDF URLs use temporary SAS tokens with 5-minute expiry
    URLs are regenerated on each request
    No persistent storage of sensitive URLs in client
Access Control
    Territory-based filtering applied for KAM users
    Role-based permissions enforced at API level
    Audit logging for all quotation actions
Business Rule Enforcement
    Server-side validation prevents duplicate final quotations
    Status transitions enforced (only Created â†’ Shared allowed)
    Immutability enforced after sharing

Monitoring &amp; Observability
Audit Events
All quotation actions create audit log entries:

    QUOTE SHARED: When quotation shared with customer
    QUOTE PDF GENERATED: When PDF created
    QUOTE PDF ACCESSED: When PDF URL requested
Metrics to Monitor
    PDF generation success rate
    Share action success rate
    SAS token expiry handling
    Business rule violation attempts

Testing
Unit Tests

describe(&#39;Quotation PDF API&#39;, () =&gt; {
  it(&#39;should return PDF URL for valid quotation&#39;, async () =&gt; {
    const response = await request(app)
      .get(&#39;/api/v1/quotations/QUOTE-001/pdf&#39;)
      .expect(200);
      
    expect(response.body.success).toBe(true);
    expect(response.body.data.pdfUrl).toMatch(/blob\.storage\.azure\.com/);
  });
  
  it(&#39;should handle share conflicts&#39;, async () =&gt; {
    const response = await request(app)
      .patch(&#39;/api/v1/quotations/QUOTE-002/share&#39;)
      .expect(409);
      
    expect(response.body.error.message).toContain(&#39;already has a final quotation&#39;);
  });
});

Integration Tests
PDF generation workflow
Share validation business rules
Error handling scenarios
Audit log integration
</code></pre>

</div>
</body>
</html>